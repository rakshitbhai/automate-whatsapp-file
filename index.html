<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=width=device-width, initial-scale=1.0"
    />
    <title>Chatrik</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="styles/styles.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  </head>

  <body>
    <div class="container">
      <!-- Hidden audio elements that will be pre-loaded -->
      <audio id="power-on-sound" preload="auto">
        <source src="assets/power-on.mp3" type="audio/mp3" />
      </audio>
      <audio id="power-off-sound" preload="auto">
        <source src="assets/power-off.mp3" type="audio/mp3" />
      </audio>

      <div class="header-logo">
        <div class="logo-content">
          <img src="assets/icon.png" alt="Chatrik Logo" />
          <h1>Chatrik</h1>
        </div>
        <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">
          <svg
            class="sun-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            ></path>
          </svg>
          <svg
            class="moon-icon hidden"
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="text-xl font-bold mb-1">1. Connect to WhatsApp</h2>
          <p class="text-sm text-gray-500 mb-4">
            Scan the QR code with your WhatsApp to begin
          </p>
        </div>

        <div id="connection-status" class="mb-4">
          <span class="status status-disconnected">Disconnected</span>
        </div>

        <div id="qr-container" class="qr-container hidden">
          <div id="qrcode"></div>
          <p class="text-sm text-gray-600 mt-4 text-center">
            Open WhatsApp on your phone, tap Menu or Settings and select
            WhatsApp Web
          </p>
        </div>

        <div class="flex space-x-3">
          <button id="connect-btn" class="btn btn-primary">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M5 12h14"></path>
              <path d="M12 5v14"></path>
            </svg>
            <span>Connect WhatsApp</span>
          </button>
          <button id="logout-btn" class="btn btn-danger hidden">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Logout</span>
          </button>
          <div id="loading-indicator" class="hidden flex items-center">
            <div class="spinner"></div>
            <span>Connecting...</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="text-xl font-bold mb-1">2. Configure Settings</h2>
          <p class="text-sm text-gray-500 mb-4">
            Set up your automation preferences
          </p>
        </div>

        <div class="mb-6">
          <label class="font-medium flex items-center mb-1">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2 text-blue-600"
            >
              <path
                d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            Output Folder to Watch
          </label>
          <p class="text-xs text-gray-500 mb-2">
            Files added to this folder will be automatically sent
          </p>
          <div class="flex mt-1">
            <input
              type="text"
              id="folder-path"
              class="form-control flex-grow"
              placeholder="Select a folder to watch..."
              disabled
            />
            <button
              id="select-folder-btn"
              class="btn btn-secondary ml-2"
              disabled
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              Browse
            </button>
          </div>
        </div>

        <div class="mb-6">
          <label class="font-medium flex items-center mb-1">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2 text-green-600"
            >
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Select WhatsApp Recipient
          </label>
          <p class="text-xs text-gray-500 mb-2">
            Choose a group to receive your files
          </p>
          <div class="custom-select-container mt-1">
            <input
              type="text"
              id="chat-search"
              class="form-control search-input"
              placeholder="Search for a chat..."
              disabled
            />
            <div class="search-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
            <div id="chat-dropdown" class="chat-dropdown hidden"></div>
            <input type="hidden" id="selected-chat-id" value="" />
            <div id="selected-chat-display" class="mt-2"></div>
            <div
              id="chats-loading-indicator"
              class="mt-2 text-blue-600 hidden flex items-center"
            >
              <div class="spinner inline-block"></div>
              <span class="ml-1">Loading chats...</span>
            </div>
          </div>
        </div>

        <div class="mb-6">
          <label class="font-medium flex items-center mb-1">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2 text-purple-600"
            >
              <path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"
              ></path>
            </svg>
            Caption for Documents
          </label>
          <p class="text-xs text-gray-500 mb-2">
            Add an optional message to accompany your files
          </p>
          <textarea
            id="caption-input"
            class="form-control textarea-control mt-1"
            placeholder="Enter caption for documents (optional)"
            disabled
          ></textarea>
        </div>

        <!-- Power button & Shutdown settings in a separate container with better styling -->
        <div class="mb-4 config-settings-container">
          <div class="flex justify-between items-center">
            <div>
              <label class="flex items-center font-medium mb-1">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="mr-2 text-gray-600"
                >
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
                Shutdown PC after sending file
              </label>
              <p class="text-sm text-gray-600 mt-1">
                System will shutdown after the final transfer
              </p>
            </div>

            <!-- Premium Power Button using iframe -->
            <div
              id="power-button-container"
              class="power-button-outer-container"
            >
              <div class="power-button-glow"></div>
              <iframe
                id="power-button-frame"
                src="components/power-button.html"
                sandbox="allow-scripts allow-same-origin"
                frameborder="0"
                scrolling="no"
                style="
                  width: 180px;
                  height: 214px;
                  border: none;
                  background: transparent;
                "
              ></iframe>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="text-xl font-bold mb-1">3. Control</h2>
          <p class="text-sm text-gray-500 mb-4">
            Start or stop the automation process
          </p>
        </div>

        <!-- Cat animation using iframe with lazy loading and sandbox -->
        <div class="animation-container">
          <iframe
            id="cat-animation-frame"
            data-src="components/cat-animation.html"
            sandbox="allow-scripts allow-same-origin"
            loading="lazy"
            frameborder="0"
            scrolling="no"
            style="width: 100%; height: 280px; border: none"
          ></iframe>
        </div>

        <div class="flex space-x-3 flex-wrap">
          <button id="start-btn" class="btn btn-primary" disabled>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Start Watching
          </button>
          <button id="stop-btn" class="btn btn-danger" disabled>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="6" y="6" width="12" height="12" rx="1"></rect>
            </svg>
            Stop Watching
          </button>
        </div>
      </div>

      <!-- File Transfer Section - Hidden by default -->
      <div class="transfer-section-container" id="transfer-section-container">
        <div class="card">
          <div class="card-header">
            <h2 class="text-xl font-bold mb-1">File Transfer Status</h2>
            <p class="text-sm text-gray-500 mb-2">
              Live tracking of your file delivery
            </p>
          </div>

          <div id="transfer-container" class="transfer-card">
            <div
              class="mb-3 flex justify-between items-center file-status-card p-3 bg-blue-50 rounded-lg"
            >
              <div class="flex items-center">
                <div class="mr-3">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#3B82F6"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
                    ></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                  </svg>
                </div>
                <div>
                  <span
                    class="font-medium text-blue-700 text-lg"
                    id="current-file"
                    >No active transfer</span
                  >
                  <span
                    class="block text-blue-500 text-sm"
                    id="file-size-display"
                  ></span>
                </div>
              </div>
            </div>

            <!-- Truck animation using iframe with lazy loading and loaded only when needed -->
            <div id="truck-animation-container">
              <!-- Placeholder until truck animation is needed -->
              <div
                id="truck-animation-placeholder"
                class="bg-gray-100 rounded-md flex items-center justify-center"
                style="width: 100%; height: 200px"
              >
                <span class="text-gray-400"
                  >Delivery animation will appear here when a transfer
                  begins...</span
                >
              </div>
              <!-- Actual iframe will be loaded when needed -->
            </div>

            <!-- Progress bar with enhanced styling -->
            <div class="relative pt-1">
              <div class="flex mb-2 items-center justify-between">
                <div>
                  <span
                    id="progress-status"
                    class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-100"
                  >
                    Initializing...
                  </span>
                </div>
                <div class="text-right">
                  <span
                    id="progress-text"
                    class="text-xs font-semibold inline-block text-blue-600"
                    >0%</span
                  >
                </div>
              </div>
              <div
                class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700 overflow-hidden"
              >
                <div
                  id="progress-bar"
                  class="progress-gradient rounded-full h-3"
                  style="width: 0%"
                ></div>
              </div>
              <div class="flex justify-between text-xs text-gray-600 mt-2">
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mr-1"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span id="elapsed-time">Elapsed: 0s</span>
                </div>
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mr-1"
                  >
                    <line x1="12" y1="2" x2="12" y2="6"></line>
                    <line x1="12" y1="18" x2="12" y2="22"></line>
                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                    <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                    <line x1="2" y1="12" x2="6" y2="12"></line>
                    <line x1="18" y1="12" x2="22" y2="12"></line>
                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                    <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                  </svg>
                  <span id="transfer-speed">0 MB/s</span>
                </div>
              </div>
            </div>

            <div
              class="mt-4 p-4 rounded-md bg-gray-50 border border-gray-200"
              id="transfer-details"
            >
              <div class="flex items-center space-x-2 mb-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="#3B82F6"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span class="text-sm font-medium text-gray-700"
                  >Transfer Details</span
                >
              </div>
              <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mr-2"
                  >
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <polyline points="17 11 19 13 23 9"></polyline>
                  </svg>
                  Destination:
                </div>
                <div id="transfer-destination" class="truncate font-medium">
                  -
                </div>
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mr-2"
                  >
                    <path
                      d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    ></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                  File type:
                </div>
                <div id="transfer-file-type" class="font-medium">-</div>
                <div class="flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mr-2"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  ETA:
                </div>
                <div id="transfer-eta" class="font-medium">Calculating...</div>
              </div>
            </div>
          </div>

          <!-- Success animation container -->
          <div id="confirmation-container" class="mt-3">
            <div class="success-checkmark">
              <div class="check-icon">
                <span class="icon-line line-tip"></span>
                <span class="icon-line line-long"></span>
                <div class="icon-circle"></div>
                <div class="icon-fix"></div>
              </div>
            </div>
            <div class="text-center">
              <div
                class="font-medium text-green-700 text-lg"
                id="confirm-message"
              >
                File sent successfully!
              </div>
              <div
                class="text-sm text-green-600 mt-2"
                id="confirm-details"
              ></div>
              <div class="text-xs text-gray-500 mt-2" id="confirm-stats"></div>
            </div>
          </div>

          <!-- Error animation container -->
          <div id="error-container" class="mt-3">
            <div class="error-x-mark">
              <div class="x-icon">
                <span class="icon-line line-left"></span>
                <span class="icon-line line-right"></span>
              </div>
            </div>
            <div class="text-center">
              <div class="font-medium text-red-700 text-lg" id="error-message">
                Transfer failed
              </div>
              <div class="text-sm text-red-600 mt-2" id="error-details"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="text-xl font-bold mb-1">Activity Log</h2>
          <p class="text-sm text-gray-500 mb-4">
            Real-time monitoring of application events
          </p>
        </div>
        <div id="log-container" class="log-container">
          <div id="log-container-content" class="log-container-content"></div>
        </div>
      </div>

      <footer class="mt-6 text-center text-gray-500 text-sm">
        <p>Chatrik &copy; 2025</p>
        <p class="mt-1">
          Files will be sent automatically when detected in the watched folder
        </p>
      </footer>
    </div>

    <script>
      // Renderer process
      const { ipcRenderer } = require("electron");

      // Elements
      const connectBtn = document.getElementById("connect-btn");
      const logoutBtn = document.getElementById("logout-btn");
      const themeToggle = document.getElementById("theme-toggle");
      const selectFolderBtn = document.getElementById("select-folder-btn");
      const folderPathInput = document.getElementById("folder-path");
      const chatSearch = document.getElementById("chat-search");
      const chatDropdown = document.getElementById("chat-dropdown");
      const selectedChatId = document.getElementById("selected-chat-id");
      const selectedChatDisplay = document.getElementById(
        "selected-chat-display"
      );
      const captionInput = document.getElementById("caption-input");
      const startBtn = document.getElementById("start-btn");
      const stopBtn = document.getElementById("stop-btn");
      const connectionStatus = document.getElementById("connection-status");
      const qrContainer = document.getElementById("qr-container");
      const logContainer = document.getElementById("log-container");
      const loadingIndicator = document.getElementById("loading-indicator");
      const chatsLoadingIndicator = document.getElementById(
        "chats-loading-indicator"
      );
      const catAnimationFrame = document.getElementById("cat-animation-frame");
      const truckAnimationContainer = document.getElementById(
        "truck-animation-container"
      );
      const truckAnimationPlaceholder = document.getElementById(
        "truck-animation-placeholder"
      );
      let truckAnimationFrame = null;

      // Progress tracking elements
      const transferSectionContainer = document.getElementById(
        "transfer-section-container"
      );
      const transferContainer = document.getElementById("transfer-container");
      const currentFile = document.getElementById("current-file");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      const elapsedTime = document.getElementById("elapsed-time");
      const transferStatus = document.getElementById("progress-status");
      const transferSpeed = document.getElementById("transfer-speed");
      const transferDetails = document.getElementById("transfer-details");
      const transferDestination = document.getElementById(
        "transfer-destination"
      );
      const transferFileType = document.getElementById("transfer-file-type");
      const transferEta = document.getElementById("transfer-eta");
      const confirmationContainer = document.getElementById(
        "confirmation-container"
      );
      const confirmMessage = document.getElementById("confirm-message");
      const confirmDetails = document.getElementById("confirm-details");
      const confirmStats = document.getElementById("confirm-stats");
      const errorContainer = document.getElementById("error-container");
      const errorMessage = document.getElementById("error-message");
      const errorDetails = document.getElementById("error-details");

      // Variables
      let isConnected = false;
      let selectedFolder = "";
      let selectedChat = "";
      let isWatching = false;
      let allChats = [];
      let activeTransferId = null;
      let userConfig = null; // Store loaded configuration
      let catAnimationLoaded = false;
      let truckAnimationLoaded = false;
      let truckAnimationInitialized = false; // Track if truck iframe has been created
      let isShutdownEnabled = false; // Track if shutdown is enabled

      // Dark mode functionality
      function initTheme() {
        // Check for saved theme preference or default to light mode
        const savedTheme = localStorage.getItem("theme") || "light";
        applyTheme(savedTheme);
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);

        // Update icon visibility
        const sunIcon = themeToggle.querySelector(".sun-icon");
        const moonIcon = themeToggle.querySelector(".moon-icon");

        if (theme === "dark") {
          sunIcon.classList.add("hidden");
          moonIcon.classList.remove("hidden");
        } else {
          sunIcon.classList.remove("hidden");
          moonIcon.classList.add("hidden");
        }

        // Send theme update to cat animation iframe
        if (catAnimationLoaded && catAnimationFrame.contentWindow) {
          catAnimationFrame.contentWindow.postMessage(
            {
              action: "updateTheme",
              theme: theme,
            },
            "*"
          );
        }

        // Send theme update to power button iframe
        const powerButtonFrame = document.getElementById("power-button-frame");
        if (powerButtonFrame && powerButtonFrame.contentWindow) {
          powerButtonFrame.contentWindow.postMessage(
            {
              action: "updateTheme",
              theme: theme,
            },
            "*"
          );
        }

        // Send theme update to truck animation iframe
        if (
          truckAnimationLoaded &&
          truckAnimationFrame &&
          truckAnimationFrame.contentWindow
        ) {
          truckAnimationFrame.contentWindow.postMessage(
            {
              action: "updateTheme",
              theme: theme,
            },
            "*"
          );
        }

        // Save preference
        localStorage.setItem("theme", theme);
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme(newTheme);
      }

      // Theme toggle event listener
      themeToggle.addEventListener("click", toggleTheme);

      // Lazy loading for iframes
      function observeElement(element, callback) {
        const observer = new IntersectionObserver(
          (entries, observer) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                callback();
                observer.disconnect();
              }
            });
          },
          { threshold: 0.1 }
        );

        observer.observe(element);
      }

      // Initialize the cat animation iframe when it becomes visible
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize theme on page load
        initTheme();

        // Setup intersection observer for cat animation
        observeElement(document.querySelector(".animation-container"), () => {
          // Load the cat animation iframe when it scrolls into view
          if (!catAnimationFrame.src) {
            console.log("Lazy loading cat animation...");
            catAnimationFrame.src = catAnimationFrame.getAttribute("data-src");
          }
        });
      });

      // Function to create the truck animation iframe when needed
      function initializeTruckAnimation() {
        if (truckAnimationInitialized) return;

        console.log("Initializing truck animation...");

        // Remove placeholder
        if (truckAnimationPlaceholder) {
          truckAnimationPlaceholder.remove();
        }

        // Create the iframe element
        truckAnimationFrame = document.createElement("iframe");
        truckAnimationFrame.id = "truck-animation-frame";
        truckAnimationFrame.src = "components/truck-animation.html";
        truckAnimationFrame.setAttribute(
          "sandbox",
          "allow-scripts allow-same-origin"
        );
        truckAnimationFrame.setAttribute("frameborder", "0");
        truckAnimationFrame.setAttribute("scrolling", "no");
        truckAnimationFrame.style.width = "100%";
        truckAnimationFrame.style.height = "200px";
        truckAnimationFrame.style.border = "none";

        // Add to container
        truckAnimationContainer.appendChild(truckAnimationFrame);
        truckAnimationInitialized = true;

        // Wait for iframe to load
        truckAnimationFrame.onload = function () {
          console.log("Truck animation frame loaded");
        };
      }

      // Listen for messages from animation iframes
      window.addEventListener("message", function (event) {
        const data = event.data;

        if (data.type === "catAnimationLoaded") {
          catAnimationLoaded = true;
          console.log("Cat animation frame loaded");

          // Send current theme to cat animation on load
          const currentTheme =
            document.documentElement.getAttribute("data-theme") || "light";
          if (catAnimationFrame.contentWindow) {
            catAnimationFrame.contentWindow.postMessage(
              {
                action: "updateTheme",
                theme: currentTheme,
              },
              "*"
            );
          }
        } else if (data.type === "truckAnimationLoaded") {
          truckAnimationLoaded = true;
          console.log("Truck animation frame loaded");

          // Send current theme to truck animation on load
          const currentTheme =
            document.documentElement.getAttribute("data-theme") || "light";
          if (truckAnimationFrame && truckAnimationFrame.contentWindow) {
            truckAnimationFrame.contentWindow.postMessage(
              {
                action: "updateTheme",
                theme: currentTheme,
              },
              "*"
            );
          }
        } else if (data.type === "catStateChanged") {
          console.log("Cat state changed:", data.watching);
        } else if (data.type === "requestTheme") {
          // Animation iframes are requesting current theme
          const currentTheme =
            document.documentElement.getAttribute("data-theme") || "light";

          // Send to cat animation if loaded
          if (catAnimationFrame.contentWindow) {
            catAnimationFrame.contentWindow.postMessage(
              {
                action: "updateTheme",
                theme: currentTheme,
              },
              "*"
            );
          }

          // Send to truck animation if loaded
          if (
            truckAnimationLoaded &&
            truckAnimationFrame &&
            truckAnimationFrame.contentWindow
          ) {
            truckAnimationFrame.contentWindow.postMessage(
              {
                action: "updateTheme",
                theme: currentTheme,
              },
              "*"
            );
          }
        } else if (data.type === "catThemeChanged") {
          console.log("Cat animation theme updated:", data.theme);
        }
      });

      // Cat animation control function - now sends message to iframe
      function updateCatAnimation(watching) {
        if (catAnimationLoaded && catAnimationFrame.contentWindow) {
          catAnimationFrame.contentWindow.postMessage(
            {
              action: "updateCatAnimation",
              watching: watching,
            },
            "*"
          );
        }
      }

      // Truck animation state manager - now sends message to iframe
      function updateTruckAnimation(state, percent = 0) {
        if (
          truckAnimationLoaded &&
          truckAnimationFrame &&
          truckAnimationFrame.contentWindow
        ) {
          truckAnimationFrame.contentWindow.postMessage(
            {
              action: "updateTruckAnimation",
              state: state,
              percent: percent,
            },
            "*"
          );
        }
      }

      // Load saved configuration when the app starts
      async function loadSavedConfiguration() {
        try {
          userConfig = await ipcRenderer.invoke("load-user-config");

          if (userConfig) {
            // Restore folder path
            if (userConfig.folderPath) {
              selectedFolder = userConfig.folderPath;
              folderPathInput.value = userConfig.folderPath;
              addLog(`Loaded saved folder path: ${userConfig.folderPath}`);
            }

            // Restore caption
            if (userConfig.caption) {
              captionInput.value = userConfig.caption;
              addLog(`Loaded saved caption`);
            }

            // Chat will be restored after connection is established
            // We can't restore it immediately because we need the chat list first
          }
        } catch (error) {
          addLog(`Error loading saved configuration: ${error}`);
        }
      }

      // Save current configuration to disk
      function saveConfiguration() {
        if (!userConfig) userConfig = {};

        userConfig.folderPath = selectedFolder;
        userConfig.chatId = selectedChat;
        userConfig.chatName = selectedChatDisplay.textContent.replace(
          "Selected: ",
          ""
        );
        userConfig.caption = captionInput.value;

        ipcRenderer.send("save-user-config", userConfig);
      }

      // Update the folder selection function to save the config
      selectFolderBtn.addEventListener("click", async () => {
        const folder = await ipcRenderer.invoke("select-folder");
        if (folder) {
          selectedFolder = folder;
          folderPathInput.value = folder;
          addLog(`Selected folder: ${folder}`);
          updateButtonState();

          // Save the updated configuration
          saveConfiguration();
        }
      });

      // Update the chat selection function to save the config
      function selectChat(id, name) {
        selectedChat = id;
        selectedChatId.value = id;
        selectedChatDisplay.textContent = `Selected: ${name}`;
        selectedChatDisplay.classList.add("visible"); // Make the display visible
        chatDropdown.classList.add("hidden");
        chatSearch.value = "";
        addLog(`Selected chat: ${name}`);
        updateButtonState();

        // Save the updated configuration
        saveConfiguration();
      }

      // Update caption input event to save configuration
      captionInput.addEventListener("input", () => {
        ipcRenderer.send("update-caption", captionInput.value);
        updateButtonState();

        // Debounce the save to avoid too many writes
        clearTimeout(captionInput._saveTimeout);
        captionInput._saveTimeout = setTimeout(() => {
          saveConfiguration();
        }, 500);
      });

      // Function to restore chat selection after connection is established
      function restoreChatSelection() {
        if (userConfig && userConfig.chatId && allChats.length > 0) {
          // Try to find the chat in the loaded chats
          const savedChat = allChats.find(
            (chat) => chat.id === userConfig.chatId
          );

          if (savedChat) {
            selectChat(savedChat.id, savedChat.name);
            addLog(`Restored saved chat: ${savedChat.name}`);
          } else {
            addLog("Saved chat not found in current chat list");
          }
        }
      }

      // Update the whatsapp-chats event handler to restore chat selection
      ipcRenderer.on("whatsapp-chats", (event, chats) => {
        allChats = chats;
        addLog(`Loaded ${chats.length} chats`);
        chatsLoadingIndicator.classList.add("hidden");

        // Try to restore saved chat selection
        restoreChatSelection();
      });

      // Load configuration when the app starts
      window.addEventListener("DOMContentLoaded", () => {
        loadSavedConfiguration();
      });

      // Add the missing chat search input event listener
      chatSearch.addEventListener("input", () => {
        const query = chatSearch.value.trim();

        if (query.length > 0) {
          chatDropdown.classList.remove("hidden");
          filterChats(query);
        } else {
          chatDropdown.classList.add("hidden");
        }
      });

      // Also add a click handler to show all chats when clicking on the search field
      chatSearch.addEventListener("click", () => {
        if (isConnected && allChats.length > 0) {
          chatDropdown.classList.remove("hidden");
          filterChats(""); // Empty query shows all chats
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !chatSearch.contains(e.target) &&
          !chatDropdown.contains(e.target)
        ) {
          chatDropdown.classList.add("hidden");
        }
      });

      // Functions
      function addLog(message) {
        // Filter out sensitive information and irrelevant logs
        if (shouldSkipLog(message)) {
          return; // Skip this log entry entirely
        }

        // Sanitize the message to remove sensitive data
        const sanitizedMessage = sanitizeLogMessage(message);

        const logEntry = document.createElement("div");
        logEntry.className = "log-entry";

        // Format the timestamp with terminal-style coloring
        const timestamp = new Date().toLocaleTimeString();
        let formattedMessage = "";

        // Add a terminal prompt-like prefix for better terminal feel
        if (sanitizedMessage.startsWith("ERROR:")) {
          // Red text for errors
          formattedMessage = `<span style="color: #ff6b6b;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else if (
          sanitizedMessage.includes("Shutdown after transfer enabled")
        ) {
          // Red text for shutdown notifications to make them stand out
          formattedMessage = `<span style="color: #ff6b6b;">[${timestamp}] $ *** ${sanitizedMessage} ***</span>`;
        } else if (sanitizedMessage.includes("disabled")) {
          // Orange text for disabled/standby status
          formattedMessage = `<span style="color: #ffd43b;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else if (
          sanitizedMessage.includes("started") ||
          sanitizedMessage.includes("Starting")
        ) {
          // Green text for starts
          formattedMessage = `<span style="color: #69db7c;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else if (
          sanitizedMessage.includes("stopped") ||
          sanitizedMessage.includes("Stopping")
        ) {
          // Yellow text for stops
          formattedMessage = `<span style="color: #ffd43b;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else if (
          sanitizedMessage.includes("Connected") ||
          sanitizedMessage.includes("ready") ||
          sanitizedMessage.includes("authenticated")
        ) {
          // Cyan text for connection messages
          formattedMessage = `<span style="color: #4dabf7;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else if (sanitizedMessage.includes("✅")) {
          // Success messages
          formattedMessage = `<span style="color: #69db7c;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else if (sanitizedMessage.includes("❌")) {
          // Failure messages
          formattedMessage = `<span style="color: #ff6b6b;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        } else {
          // Default text color
          formattedMessage = `<span style="color: #d1e5f7;">[${timestamp}] $ ${sanitizedMessage}</span>`;
        }

        // Set the HTML content to allow formatting
        logEntry.innerHTML = formattedMessage;

        // Add the log entry to the log container content
        const logContainerContent = document.getElementById(
          "log-container-content"
        );
        logContainerContent.appendChild(logEntry);

        // Auto-scroll to bottom
        logContainerContent.scrollTop = logContainerContent.scrollHeight;
      }

      // Function to determine if a log message should be skipped entirely
      function shouldSkipLog(message) {
        // Skip debug or technical logs that aren't relevant to users
        const skipPatterns = [
          "QR code generated in UI",
          "Lazy loading cat animation",
          "Cat animation frame loaded",
          "Truck animation frame loaded",
          "Cat state changed",
          "Initializing truck animation",
          "postMessage",
          "contentWindow",
          "observer",
          "intersection",
          "socket.io",
          "[object Object]",
          "undefined",
          "NaN",
          "Using Baileys built-in auth system",
          "Library/Application Support",
          "/baileys-auth",
          "auth system at",
          "Fetching WhatsApp chats and contacts using official Baileys method",
          "Shutdown after send set to:",
        ];

        // Skip any message containing these terms
        return skipPatterns.some((pattern) => message.includes(pattern));
      }

      // Function to sanitize log messages by removing/obfuscating sensitive data
      function sanitizeLogMessage(message) {
        // Start with the original message
        let sanitized = message;

        // Skip or sanitize authentication system path messages
        if (message.includes("auth system")) {
          return "Authentication system initialized";
        }

        // Obfuscate full file paths, showing only the filename
        sanitized = sanitized.replace(
          /([A-Za-z]:\\(?:[^\\]+\\)*|\/(?:[^\/]+\/)*)([\w\s.-]+\.\w+)/g,
          "***/$2"
        );

        // Obfuscate chat IDs which are usually in format like 1234567890@c.us
        sanitized = sanitized.replace(/\b\d+@[a-z.]+\b/g, "[CHAT-ID]");

        // Replace long numeric sequences (like IDs) with shorter versions
        sanitized = sanitized.replace(/\b\d{8,}\b/g, "[ID-***]");

        // Remove IP addresses
        sanitized = sanitized.replace(
          /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g,
          "[IP-ADDRESS]"
        );

        // For selected folder logs, show only that a folder was selected, not the path
        if (message.includes("Selected folder:")) {
          sanitized = "Selected output folder successfully";
        }

        // For selected chat logs, remove specific chat names for privacy
        if (message.includes("Selected chat:")) {
          sanitized = "Selected recipient successfully";
        }

        // Remove any base64 data that might appear in logs
        sanitized = sanitized.replace(
          /data:[^;]+;base64,[a-zA-Z0-9+/=]+/g,
          "[BASE64-DATA]"
        );

        // Remove any file system paths to user directories
        sanitized = sanitized.replace(
          /\/Users\/[^\/]+\/[^\s]+/g,
          "[USER-PATH]"
        );

        return sanitized;
      }

      function updateStatus(status) {
        if (status === "connected") {
          isConnected = true;
          connectionStatus.innerHTML =
            '<span class="status status-connected">Connected</span>';
          qrContainer.classList.add("hidden");
          connectBtn.classList.add("hidden");
          logoutBtn.classList.remove("hidden");
          loadingIndicator.classList.add("hidden");
          selectFolderBtn.disabled = false;
          folderPathInput.disabled = false;
          chatSearch.disabled = false;
          captionInput.disabled = false;

          // If a chat was previously selected, make sure it's visible
          if (selectedChat) {
            selectedChatDisplay.classList.add("visible");
          }
        } else if (status === "disconnected") {
          isConnected = false;
          connectionStatus.innerHTML =
            '<span class="status status-disconnected">Disconnected</span>';
          connectBtn.classList.remove("hidden");
          logoutBtn.classList.add("hidden");
          qrContainer.classList.add("hidden"); // Ensure QR is hidden when disconnected
          loadingIndicator.classList.add("hidden");
          selectFolderBtn.disabled = true;
          folderPathInput.disabled = true;
          chatSearch.disabled = true;
          captionInput.disabled = true;
          startBtn.disabled = true;
          stopBtn.disabled = true;
          selectedChatDisplay.textContent = "";
          selectedChatId.value = "";
          selectedChatDisplay.classList.remove("visible"); // Hide the selected chat display when disconnected
          selectedChat = ""; // Clear the selected chat
        } else if (status === "loading") {
          connectionStatus.innerHTML =
            '<span class="status status-loading">Connecting...</span>';
          connectBtn.classList.add("hidden");
          loadingIndicator.classList.remove("hidden");
          qrContainer.classList.add("hidden"); // Hide QR while loading
          selectedChatDisplay.classList.remove("visible"); // Hide the selected chat display while loading
        }
      }

      function updateButtonState() {
        const canStart =
          isConnected && selectedFolder && selectedChat && !isWatching;
        const canStop = isConnected && isWatching;

        startBtn.disabled = !canStart;
        stopBtn.disabled = !canStop;
      }

      function filterChats(query) {
        query = query.toLowerCase();
        chatDropdown.innerHTML = "";

        if (!allChats || allChats.length === 0) {
          chatDropdown.innerHTML =
            '<div class="no-results">No chats available</div>';
          return;
        }

        const groups = allChats.filter(
          (chat) => chat.isGroup && chat.name.toLowerCase().includes(query)
        );
        const contacts = allChats.filter(
          (chat) => !chat.isGroup && chat.name.toLowerCase().includes(query)
        );

        if (groups.length === 0 && contacts.length === 0) {
          chatDropdown.innerHTML =
            '<div class="no-results">No matches found</div>';
          return;
        }

        // Add groups
        if (groups.length > 0) {
          const groupCategory = document.createElement("div");
          groupCategory.className = "chat-category";
          groupCategory.textContent = "Groups";
          chatDropdown.appendChild(groupCategory);

          groups.forEach((group) => {
            const option = document.createElement("div");
            option.className = "chat-option";
            option.dataset.id = group.id;
            option.dataset.name = group.name;
            option.textContent = group.name;
            option.addEventListener("click", () =>
              selectChat(group.id, group.name)
            );
            chatDropdown.appendChild(option);
          });
        }

        // Add contacts
        if (contacts.length > 0) {
          const contactCategory = document.createElement("div");
          contactCategory.className = "chat-category";
          contactCategory.textContent = "Contacts";
          chatDropdown.appendChild(contactCategory);

          contacts.forEach((contact) => {
            const option = document.createElement("div");
            option.className = "chat-option";
            option.dataset.id = contact.id;
            option.dataset.name = contact.name;
            option.textContent = contact.name;
            option.addEventListener("click", () =>
              selectChat(contact.id, contact.name)
            );
            chatDropdown.appendChild(option);
          });
        }
      }

      // File size formatter function
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
        else if (bytes < 1073741824)
          return (bytes / 1048576).toFixed(1) + " MB";
        else return (bytes / 1073741824).toFixed(2) + " GB";
      }

      // New and improved upload progress handler
      ipcRenderer.on("upload-progress", (event, data) => {
        // First show the entire transfer section container
        transferSectionContainer.classList.add("visible");

        // Initialize truck animation if not already done
        if (!truckAnimationInitialized) {
          initializeTruckAnimation();
        }

        // After container is visible, show the transfer card with animation
        setTimeout(() => {
          // Show transfer container with animation
          transferContainer.classList.add("visible");
          confirmationContainer.classList.remove("visible");
          errorContainer.classList.remove("visible");

          // Show the truck scene with animation
          if (truckAnimationFrame && truckAnimationFrame.contentWindow) {
            truckAnimationFrame.contentWindow.postMessage(
              {
                action: "showTruck",
              },
              "*"
            );
          }
        }, 300); // Short delay for smooth sequential transitions

        // Display file size
        document.getElementById("file-size-display").textContent =
          data.fileSize || "";

        // Update current file name
        currentFile.textContent = `Sending: ${data.file}`;

        // Update progress bar
        const progressPercent =
          typeof data.progress === "number"
            ? data.progress
            : parseInt(data.progress, 10);
        progressBar.style.width = `${progressPercent}%`;
        progressText.textContent = `${progressPercent}%`;

        // Update elapsed time
        elapsedTime.textContent = `Elapsed: ${data.elapsed}s`;

        // Update transfer speed
        transferSpeed.textContent = `${data.speed} MB/s`;

        // Update transfer details
        transferDestination.textContent = data.destination || "-";
        transferFileType.textContent = data.fileType || "-";
        transferEta.textContent = data.eta || "Calculating...";

        // Update truck animation state based on progress
        if (progressPercent < 10) {
          updateTruckAnimation("starting");
          transferStatus.textContent = "STARTING DELIVERY...";
          transferStatus.className =
            "text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-100";
        } else if (progressPercent < 90) {
          updateTruckAnimation("progress", progressPercent);
          transferStatus.textContent = "TRANSFERRING...";
          transferStatus.className =
            "text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-100";
        } else {
          updateTruckAnimation("completing");
          transferStatus.textContent = "ARRIVING...";
          transferStatus.className =
            "text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-100";
        }

        // Store the active transfer ID
        activeTransferId = data.transferId;
      });

      // Enhanced file sent confirmation
      ipcRenderer.on("file-sent-confirmed", (event, data) => {
        // Only show confirmation if it's for the active transfer
        if (activeTransferId === data.transferId) {
          // Show final truck delivery animation
          updateTruckAnimation("complete");

          // Hide transfer progress after a short delay to show the delivery animation
          setTimeout(() => {
            // Animate out the transfer container
            transferContainer.classList.remove("visible");

            // Hide the truck animation
            if (truckAnimationFrame && truckAnimationFrame.contentWindow) {
              truckAnimationFrame.contentWindow.postMessage(
                {
                  action: "hideTruck",
                },
                "*"
              );
            }

            // Animate in the confirmation container
            setTimeout(() => {
              confirmationContainer.classList.add("visible");
              errorContainer.classList.remove("visible");

              // Update confirmation message
              confirmMessage.textContent = `File sent successfully: ${data.file}`;

              // Add status details
              let statusText = "Delivered to server";
              if (data.status === 3) statusText = "Delivered to recipient";
              if (data.status === 4) statusText = "Read by recipient";

              confirmDetails.textContent = `${statusText}`;

              // Add stats
              confirmStats.textContent = `Transfer completed in ${data.elapsed}s | Average speed: ${data.speed} MB/s`;

              // Add log entry
              addLog(`✅ File transfer completed successfully: ${data.file}`);
              activeTransferId = null;
            }, 500); // Short delay for sequential animations
          }, 3000); // Longer delay to show the delivery animation

          // Add a timeout to hide the entire transfer section after showing confirmation
          setTimeout(() => {
            // Hide the entire transfer section container after 8 seconds
            transferSectionContainer.classList.remove("visible");
          }, 8000); // Give user time to see confirmation before hiding
        }
      });

      // Enhanced file send failure
      ipcRenderer.on("file-send-failed", (event, data) => {
        // First stop the truck animation
        updateTruckAnimation("idle");

        setTimeout(() => {
          // Animate out the transfer container
          transferContainer.classList.remove("visible");

          // Hide the truck animation
          if (truckAnimationFrame && truckAnimationFrame.contentWindow) {
            truckAnimationFrame.contentWindow.postMessage(
              {
                action: "hideTruck",
              },
              "*"
            );
          }

          setTimeout(() => {
            // Animate in the error container
            confirmationContainer.classList.remove("visible");
            errorContainer.classList.add("visible");

            // Update error message
            errorMessage.textContent = `Transfer failed: ${data.file}`;
            errorDetails.textContent = `Error: ${data.error}`;

            // Add log entry
            addLog(`❌ File transfer failed: ${data.file} - ${data.error}`);
            activeTransferId = null;
          }, 500); // Short delay for sequential animations
        }, 1000);

        // After displaying the error, set a timeout to hide the transfer section
        setTimeout(() => {
          transferSectionContainer.classList.remove("visible");
        }, 8000); // Hide after 8 seconds
      });

      // Event listeners
      connectBtn.addEventListener("click", () => {
        addLog("Initializing WhatsApp...");

        // Hide any existing QR container first
        qrContainer.classList.add("hidden");

        // Clear existing auth data to force QR code generation
        ipcRenderer.send("reset-auth-data");

        // Small delay to ensure auth reset completes
        setTimeout(() => {
          ipcRenderer.send("init-whatsapp");
          updateStatus("loading");
        }, 500);
      });

      logoutBtn.addEventListener("click", () => {
        ipcRenderer.send("logout-whatsapp");
        addLog("Logging out of WhatsApp...");
      });

      startBtn.addEventListener("click", () => {
        if (!selectedFolder || !selectedChat) {
          addLog("Error: Please select a folder and a chat first");
          return;
        }

        ipcRenderer.send("start-watching", {
          folderPath: selectedFolder,
          chatId: selectedChat,
        });

        isWatching = true;
        if (isWatching) {
          selectFolderBtn.disabled = true;
          folderPathInput.disabled = true;
          chatSearch.disabled = true;
          logoutBtn.disabled = true;
        }
        updateButtonState();
        updateCatAnimation(true);
        addLog("Watching started");
      });

      stopBtn.addEventListener("click", () => {
        ipcRenderer.send("stop-watching");
        isWatching = false;
        if (!isWatching) {
          selectFolderBtn.disabled = false;
          folderPathInput.disabled = false;
          chatSearch.disabled = false;
          logoutBtn.disabled = false;
        }
        updateButtonState();
        updateCatAnimation(false);
        addLog("Watching stopped");
      });

      // IPC listeners
      ipcRenderer.on("whatsapp-qr", (event, qr) => {
        addLog("WhatsApp QR code received. Please scan with your phone");

        // Make sure these elements are in the right state
        qrContainer.classList.remove("hidden");
        loadingIndicator.classList.add("hidden");
        connectBtn.classList.add("hidden");

        // Update connection status to show we're waiting for QR scan
        connectionStatus.innerHTML =
          '<span class="status status-waiting">Waiting for scan</span>';

        // Clear previous QR code
        const qrcodeElement = document.getElementById("qrcode");
        qrcodeElement.innerHTML = "";

        // Small delay to ensure DOM is ready
        setTimeout(() => {
          // Ensure QRCode library is loaded before generating
          if (typeof QRCode !== "undefined") {
            try {
              // Generate new QR code with larger size for better scanning
              new QRCode(qrcodeElement, {
                text: qr,
                width: 256,
                height: 256,
                colorDark: "#122c34",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H,
              });

              addLog(
                "QR code generated successfully - please scan with WhatsApp"
              );

              // Check if QR was actually rendered after a short delay
              setTimeout(() => {
                if (qrcodeElement.children.length === 0) {
                  addLog("QR code failed to render - showing alternative");
                  qrcodeElement.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 8px;">
                      <p style="margin-bottom: 10px; font-weight: bold; color: #ff6600;">QR Code Generation Issue</p>
                      <p style="margin-bottom: 10px;">Please try refreshing the app</p>
                      <button onclick="location.reload()" style="padding: 8px 16px; background: #128C7E; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload App</button>
                    </div>
                  `;
                }
              }, 1000);
            } catch (error) {
              addLog(`Error generating QR code: ${error.message}`);
              // Fallback: create a simple text representation
              qrcodeElement.innerHTML = `
                <div style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 8px;">
                  <p style="margin-bottom: 10px; font-weight: bold;">QR Code Data:</p>
                  <p style="word-break: break-all; font-family: monospace; font-size: 12px;">${qr}</p>
                  <p style="margin-top: 10px; color: #666;">Please reload the app if QR doesn't display properly</p>
                </div>
              `;
            }
          } else {
            addLog("QRCode library not loaded - attempting to reload");
            // Fallback if QRCode library isn't loaded
            qrcodeElement.innerHTML = `
              <div style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 8px;">
                <p style="color: #ff0000; font-weight: bold;">QR Library Loading Issue</p>
                <p style="margin: 10px 0;">Please refresh the app</p>
                <button onclick="location.reload()" style="padding: 8px 16px; background: #128C7E; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload App</button>
              </div>
            `;
          }
        }, 100);
      });

      ipcRenderer.on("whatsapp-loading", (event, isLoading) => {
        if (isLoading) {
          loadingIndicator.classList.remove("hidden");
          connectBtn.classList.add("hidden");
        } else {
          loadingIndicator.classList.add("hidden");
        }
      });

      ipcRenderer.on("whatsapp-ready", () => {
        addLog("WhatsApp client is ready!");
        updateStatus("connected");
        // Show chat loading indicator only after connection is established
        chatsLoadingIndicator.classList.remove("hidden");
      });

      ipcRenderer.on("whatsapp-authenticated", () => {
        addLog("WhatsApp authenticated");
        updateStatus("connected");
        // Show chat loading indicator when authenticated
        chatsLoadingIndicator.classList.remove("hidden");
      });

      ipcRenderer.on("whatsapp-auth-failure", () => {
        addLog("WhatsApp authentication failed - please try connecting again");
        updateStatus("disconnected");
        // Hide chat loading indicator on auth failure
        chatsLoadingIndicator.classList.add("hidden");
        // Clear QR container on auth failure
        qrContainer.classList.add("hidden");
      });

      ipcRenderer.on("whatsapp-disconnected", () => {
        addLog("WhatsApp disconnected");
        updateStatus("disconnected");
        isWatching = false;
        // Hide chat loading indicator on disconnect
        chatsLoadingIndicator.classList.add("hidden");
      });

      ipcRenderer.on("chats-loading", (event, isLoading) => {
        if (isLoading) {
          chatsLoadingIndicator.classList.remove("hidden");
        } else {
          chatsLoadingIndicator.classList.add("hidden");
        }
      });

      ipcRenderer.on("log", (event, message) => {
        addLog(message);
      });

      ipcRenderer.on("error", (event, message) => {
        addLog(`ERROR: ${message}`);
      });

      // Initialize - ensure the transfer section starts hidden
      updateStatus("disconnected");
      addLog("Application started");
      chatsLoadingIndicator.classList.remove("hidden");
      transferSectionContainer.classList.remove("visible"); // Ensure hidden on startup

      // Power button toggle function - updated for iframe communication
      function togglePower() {
        const powerButtonFrame = document.getElementById("power-button-frame");
        const powerButtonContainer = document.getElementById(
          "power-button-container"
        );

        // Get current state
        let isPowerOn = isShutdownEnabled;

        if (isPowerOn) {
          // Toggle to off state
          powerButtonContainer.classList.remove("active");
          isShutdownEnabled = false;
          addLog("Shutdown after transfer disabled");

          // Send message to iframe to update state
          if (powerButtonFrame && powerButtonFrame.contentWindow) {
            powerButtonFrame.contentWindow.postMessage(
              {
                action: "setPowerState",
                isPowerOn: false,
              },
              "*"
            );
          }
        } else {
          const confirmShutdown = confirm(
            "Enabling this will cause your system to shut down after the final transfer. Are you sure?"
          );
          if (!confirmShutdown) return;

          // Toggle to on state
          powerButtonContainer.classList.add("active");
          isShutdownEnabled = true;
          addLog("Shutdown after transfer enabled");

          // Send message to iframe to update state
          if (powerButtonFrame && powerButtonFrame.contentWindow) {
            powerButtonFrame.contentWindow.postMessage(
              {
                action: "setPowerState",
                isPowerOn: true,
              },
              "*"
            );
          }
        }

        ipcRenderer.send("toggle-shutdown", isShutdownEnabled);
      }

      // Listen for messages from power button iframe
      window.addEventListener("message", function (event) {
        const data = event.data;

        if (data.type === "powerButtonLoaded") {
          // Power button iframe has loaded, send initial theme
          const powerButtonFrame =
            document.getElementById("power-button-frame");
          const isDarkMode =
            document.documentElement.getAttribute("data-theme") === "dark";

          if (powerButtonFrame && powerButtonFrame.contentWindow) {
            powerButtonFrame.contentWindow.postMessage(
              {
                action: "updateTheme",
                theme: isDarkMode ? "dark" : "light",
              },
              "*"
            );

            // Send initial power state
            powerButtonFrame.contentWindow.postMessage(
              {
                action: "setPowerState",
                isPowerOn: isShutdownEnabled,
              },
              "*"
            );
          }
        } else if (data.type === "powerButtonStateChanged") {
          // Handle power button state change from iframe
          togglePower();
        } else if (data.type === "powerButtonContainerActive") {
          // Handle container glow effect
          const powerButtonContainer = document.getElementById(
            "power-button-container"
          );
          if (data.isActive) {
            powerButtonContainer.classList.add("active");
          } else {
            powerButtonContainer.classList.remove("active");
          }
        }
      });
    </script>
  </body>
</html>
